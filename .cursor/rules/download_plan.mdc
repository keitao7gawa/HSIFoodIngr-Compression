# HSIFoodIngr-64 データセットダウンロード機能 開発計画

## 概要
HSIFoodIngr-64データセットをHarvard Dataverseから自動ダウンロードするCLI機能を実装する．

## 対象データセット
- **URL**: https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/E7WDNQ&version=&q=&fileTypeGroupFacet=&fileAccess=&tagPresort=true&folderPresort=true
- **Persistent ID**: doi:10.7910/DVN/E7WDNQ
- **データセット名**: HSIFoodIngr-64

## 実装方法
Harvard DataverseのNative APIおよびData Access APIを組み合わせ、2段階のプロセスでダウンロードを実行する。

1. ファイルリストの取得
   データセットに含まれる全ファイルのメタデータ（ファイルID、ファイル名）をリストとして取得する。
   - エンドポイント: GET /api/datasets/:persistentId/versions/:latest
2. 個別ファイルのダウンロード
   取得したファイルリストをループ処理し、ファイルIDを元に各ファイルを個別にダウンロードする。
   - エンドポイント: GET /api/access/datafile/{id}
### 参考API仕様
- **API ドキュメント**: https://guides.dataverse.org/en/latest/api/dataaccess.html#download-by-dataset-api
- **エンドポイント**: `/api/datasets/:persistentId/versions/:latest`
- **機能**: データセットのメタデータとファイルリストを取得
- **レスポンス形式**: JSON（ファイルID、ファイル名、サイズ等を含む）

- **API ドキュメント**: https://guides.dataverse.org/en/latest/api/dataaccess.html#download-by-file-id
- **エンドポイント**: `/api/access/datafile/{id}`
- **機能**: ファイルIDを指定して個別ファイルをダウンロード
- **レスポンス形式**: バイナリデータ（ファイルの実体）

## 開発フェーズ

### フェーズ1: 基盤実装
1. **依存関係追加**
   - `requests`ライブラリの追加（HTTP通信）
   - `tqdm`ライブラリの追加（プログレスバー表示）

2. **CLIコマンド追加**
   - `hsifoodingr download` サブコマンドの実装
   - 基本オプション（出力ディレクトリ，APIキー等）

### フェーズ2: ダウンロード機能実装

#### API通信層 (dataverse_client.py)
1. **Dataverse APIクライアントクラス**
   - 基本設定（エンドポイント，タイムアウト等）
   - セッション管理と認証
   - レート制限への対応

2. **ファイルリスト取得機能**
   - メソッド: `get_file_list()`
   - データセットメタデータの解析
   - ファイルIDとパス情報の抽出

3. **個別ファイルダウンロード**
   - メソッド: `download_file_by_id()`
   - チャンク単位での効率的なダウンロード
   - プログレス表示対応
   - エラーハンドリング

#### ダウンロード処理 (downloader.py)
1. **一括ダウンロード機能**
   - ファイルリストに基づく逐次ダウンロード
   - ファイル数ベースのプログレス表示（例: [35/189]）
   - 並行ダウンロードの制御

2. **再開機能**
   - 一時ファイルの管理
   - チェックポイント保存
   - 部分ダウンロードからの再開処理

### フェーズ3: 統合・検証
1. **既存パイプラインとの統合**
   - ダウンロード完了後の自動展開
   - ファイル整合性チェック

2. **エラーハンドリング**
   - ネットワークエラー対応
   - 部分ダウンロードからの再開機能

## 実装詳細

### CLIコマンド仕様
```bash
hsifoodingr download [OPTIONS]
  --output-dir PATH    出力ディレクトリ（デフォルト: data/raw）
  --api-key TEXT       Dataverse APIキー
  --force             既存ファイルの上書き
  --resume            中断されたダウンロードの再開
```

### ファイル構造
```
hsifoodingr/
├── cli.py              # メインCLI（downloadサブコマンド追加）
├── download/
│   ├── __init__.py
│   ├── dataverse_client.py    # Dataverse APIクライアント
│   ├── downloader.py          # ダウンロード処理
│   └── utils.py               # ユーティリティ関数
└── utils/
    └── progress.py            # プログレス表示（拡張）
```

### エラーハンドリング
- ネットワークタイムアウト
- API制限（レート制限）
- ディスク容量不足
- 部分ダウンロードからの再開

## 完了基準（DoD）
1. `hsifoodingr download`コマンドが正常実行される
2. 指定されたデータセットが正常にダウンロードされる
3. プログレス表示が適切に動作する
4. エラー時の適切なメッセージ表示
5. 既存のパイプラインと統合されている

## 注意事項
- Harvard Dataverseの利用規約に準拠
- APIキーの適切な管理（環境変数での設定推奨）
- 大容量データセットのダウンロード時間考慮
- ネットワーク環境に応じたタイムアウト設定

## 参考リンク
- [Harvard Dataverse Data Access API](https://guides.dataverse.org/en/latest/api/dataaccess.html#download-by-dataset-api)
- [HSIFoodIngr-64 Dataset](https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/E7WDNQ&version=&q=&fileTypeGroupFacet=&fileAccess=&tagPresort=true&folderPresort=true)
alwaysApply: false
---
